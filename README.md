# devops-training

## Описание инструментов испоьзуемых для выполнения финального задания

В решении задания 

Для выполнения задания были использованы следющие инструменты:
* Terraform для автоматического создания/удаления инфраструктуры в Яндекс облаке. Используемая конфигурация terraform описана в директории `Terraform`:
    * файл main.tf - основной конфигурацинный файл, в котором описывается вся создаваемая инфраструктура в Яндекс облаке.
    * файл vars.tf который используется в main.tf содержащий переменые которые были проброшены в terraform из env репозитория.
    * файл .terraformrc для установки terraform-провайдера от Яндекса.
    * файлы cloud-config.yml и cloud-config-db.yml иницаилизипующие пользователей на виртуальных машинах для приложения и базы данных соответственно
* Ansible для автоматического развертывания приложения и окружения для него на виртуальные машины.
* Gitlab CI для автоматизации процесса управления инфраструктурой и развертывания приложения на виртуальные машины.


## Краткое описание решения

В решении использовалась соедующая инфраструктура: 3 виртуальные машины (2 для приложения и одна для БД) и один L3-сетевой балансировщик для балансирования нагрузки на два инстанса приложения. <br />
На каждую виртуальную машину для приложения кроме самого приложения и его окружения был также развернут кэшируюший reverse-proxy в виде nginx.<br />
Деплой приложения и деплой nginx описан через ansible в соответсвующих ansible-ролях `bingo-start` и `nginx`, которые находятся по пути `ansible/roles`. Также в этой же директироии содержатся соответствующие им плейбуки `ansible/deploy-playbook.yml` и `nginx-playbook.yml` в которых используются данные роли и запускается деплой.<br />
Для третей виртуальной машины с БД руками (из-за недостатка времени) был развернут PostgreSQL, где была проинициализированана необходимая база данных для приложения. Также в ней были созданы B-Tree индексы на колонки Sessions.id, Customers.id и Movies.id для оптимизации большого количества запросов с фильтрацией по ним.<br /><br />
В файле .gitlab-ci.yml описана небольшая конфигурация ci/cd процесса, который состоял из 4 этапов:
1. `lint` с соответсвующими джобами `lint-terraform` и `lint-ansible`, которые проверку конфигурационных файлов для Terraform и Ansible при создании MR, если таковые были изменены  
2. `create-infra` для автоматичекого создания необходимой инфраструктуры в ЯО через Terraform.<br />
На этой стадии при слитии MR в main и наличии изменений в конфигурации Terraform, автоматически запускалась джоба `terraform-plan`, которая после инициализации terraform-провайдера проводила валидацию и планирования конфигурации Terraform.<br />.
Также на этой стадии при слитии MR в main и наличии изменений в конфигурации Terraform создавалась еще одна джоба `terraform-apply` ,которая запускается в ручном режиме и после инициализации terraform-провайдера создает инфраструктуру для  из описанной ранее конфигурации.
3. `destory-infra` для автоматического удаления созданной инфрастурктуры из предыдущей стадии. Удаление происходит в соответсвующей джобе `terraform-destory` и зависит от файла состояния терраформа, который передается из предыдущей стадии. Запускается в ручном режиме.
4. `deploy` для автоматичекого развертывания приложения на несколько хостов через Ansible, который содержит джобы `bingo-deploy` и `nginx-deploy`, запускаемые также в ручном режиме, для развертывания приложения и кэширующего reverse-proxy nginx. Данные джобы запускают соответствующие им ansible-плейбуки `ansible/deploy-playbook.yml` и `ansible/nginx-playbook.yml`, которые в свою очередь используют ранее упомянутые роли `bingo-start` и `nginx`, соответсвенно.

